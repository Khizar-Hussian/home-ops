---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: qbittorrent
  namespace: media
spec:
  interval: 15m
  timeout: 10m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: default
  values:
    defaultPodOptions:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch

    controllers:
      qbittorrent:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        containers:
          qbittorrent:
            image:
              repository: ghcr.io/onedr0p/qbittorrent
              tag: 4.6.7
            env:
              TZ: America/New_York
              QBITTORRENT__PORT: &qbPort 8080
              QBITTORRENT__BT_PORT: &btPort 50413
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 2Gi

          gluetun:
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: v3.38.0
            env:
              VPN_SERVICE_PROVIDER: nordvpn
              VPN_TYPE: openvpn
              OPENVPN_USER:
                valueFrom:
                  secretKeyRef:
                    name: nordvpn-credentials
                    key: username
              OPENVPN_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: nordvpn-credentials
                    key: password
              SERVER_COUNTRIES: "United States"
              SERVER_CATEGORIES: "P2P"
              FIREWALL_OUTBOUND_SUBNETS: "192.168.0.0/16,10.42.0.0/16,10.43.0.0/16"
              LOG_LEVEL: info
            securityContext:
              capabilities:
                add:
                  - NET_ADMIN
              runAsUser: 0
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                memory: 512Mi

    service:
      qbittorrent:
        controller: qbittorrent
        ports:
          http:
            port: *qbPort

    persistence:
      config:
        existingClaim: media-nfs-pvc
        globalMounts:
          - path: /config
            subPath: config/qbittorrent
      downloads:
        existingClaim: media-nfs-pvc
        globalMounts:
          - path: /downloads
            subPath: downloads